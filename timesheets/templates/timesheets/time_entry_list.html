{% extends 'timesheets/base.html' %}

{% block title %}
<h1 class="text-xl font-semibold text-gray-900 dark:text-white">Timesheet Entries</h1>
{% endblock %}

{% block content %}
<style>
    /* Remove the default triangle marker from details/summary */
    details > summary {
        list-style: none;
    }
    details > summary::-webkit-details-marker {
        display: none;
    }
</style>
<div class="bg-white dark:bg-gray-800 overflow-hidden">
    <div class="p-6 space-y-2">
        <details class="group bg-white dark:bg-gray-800 shadow-xl rounded-2xl overflow-hidden transition-all duration-300 hover:shadow-2xl">
            <summary class="px-6 py-4 border-b border-gray-100 dark:border-gray-700 cursor-pointer hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-all">
                <div class="flex items-center justify-between">
                    <div class="flex items-center space-x-2">
                        <h3 class="text-lg font-semibold text-gray-800 dark:text-white">Search and Filter</h3>
                    </div>
                    <svg class="w-5 h-5 text-gray-600 dark:text-gray-400 transform transition-transform duration-300" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                    </svg>
                </div>
            </summary>
        
            <div class="px-6 py-4 dark:bg-gray-800">
                <form method="get" action="{% url 'timesheets:time_entry_list' %}" class="space-y-4">
                    <!-- Search Bar -->
                    <div class="flex group">
                        <div class="relative flex-grow">
                            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                                <svg class="h-4 w-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                          d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                                </svg>
                            </div>
                            <input type="text" 
                                   name="search" 
                                   value="{{ search_query }}" 
                                   placeholder="Search time entries..." 
                                   class="w-full pl-10 pr-4 py-2 bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-xl
                                          text-gray-900 dark:text-white placeholder-gray-400 dark:placeholder-gray-400
                                          focus:outline-none focus:ring-2 focus:ring-gray-500 dark:focus:ring-gray-400 focus:border-transparent
                                          focus:bg-white dark:focus:bg-gray-600
                                          transition-all duration-200">
                        </div>
                    </div>
        
                    <!-- Filters Grid -->
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-3">
                        <!-- Date Range -->
                        <div class="space-y-1">
                            <label class="text-sm font-medium text-gray-600 dark:text-gray-300">Start Date</label>
                            <input type="date" 
                                   name="start_date" 
                                   value="{{ start_date|date:'Y-m-d' }}"
                                   class="w-full pl-3 pr-3 py-2 bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-xl
                                          text-gray-900 dark:text-white
                                          focus:outline-none focus:ring-2 focus:ring-gray-500 dark:focus:ring-gray-400 focus:border-transparent
                                          focus:bg-white dark:focus:bg-gray-600
                                          transition-all duration-200">
                        </div>
        
                        <div class="space-y-1">
                            <label class="text-sm font-medium text-gray-600 dark:text-gray-300">End Date</label>
                            <input type="date" 
                                   name="end_date" 
                                   value="{{ end_date|date:'Y-m-d' }}"
                                   class="w-full pl-3 pr-3 py-2 bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-xl
                                          text-gray-900 dark:text-white
                                          focus:outline-none focus:ring-2 focus:ring-gray-500 dark:focus:ring-gray-400 focus:border-transparent
                                          focus:bg-white dark:focus:bg-gray-600
                                          transition-all duration-200">
                        </div>
        
                        <!-- Sort By Select -->
                        <div class="space-y-1">
                            <label class="text-sm font-medium text-gray-600 dark:text-gray-300">Sort By</label>
                            <div class="relative">
                                <select name="sort_by" 
                                        class="w-full pl-3 pr-8 py-2 bg-gray-50 dark:bg-gray-700 border border-gray-200 dark:border-gray-600 rounded-xl
                                               text-gray-700 dark:text-white appearance-none
                                               focus:outline-none focus:ring-2 focus:ring-gray-500 dark:focus:ring-gray-400 focus:border-transparent
                                               focus:bg-white dark:focus:bg-gray-600
                                               cursor-pointer
                                               transition-all duration-200">
                                    <option value="-date" {% if sort_by == '-date' %}selected{% endif %}>Date (Newest)</option>
                                    <option value="date" {% if sort_by == 'date' %}selected{% endif %}>Date (Oldest)</option>
                                    {% if is_superuser or is_supervisor %}
                                        <option value="user__username" {% if sort_by == 'user__username' %}selected{% endif %}>User (A-Z)</option>
                                        <option value="-user__username" {% if sort_by == '-user__username' %}selected{% endif %}>User (Z-A)</option>
                                    {% endif %}
                                    <option value="-hours_for_the_day" {% if sort_by == '-hours_for_the_day' %}selected{% endif %}>Hours (High to Low)</option>
                                    <option value="hours_for_the_day" {% if sort_by == 'hours_for_the_day' %}selected{% endif %}>Hours (Low to High)</option>
                                    <option value="-total_miles" {% if sort_by == '-total_miles' %}selected{% endif %}>Miles (High to Low)</option>
                                    <option value="total_miles" {% if sort_by == 'total_miles' %}selected{% endif %}>Miles (Low to High)</option>
                                </select>
                                <div class="absolute inset-y-0 right-0 flex items-center pr-2 pointer-events-none">
                                    <svg class="w-4 h-4 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                                    </svg>
                                </div>
                            </div>
                        </div>
                    </div>
        
                    <!-- Action Buttons -->
                    <div class="flex justify-end space-x-2 pt-3">
                        <a href="{% url 'timesheets:time_entry_list' %}" 
                           class="inline-flex items-center px-4 py-2 border border-gray-200 dark:border-gray-600 rounded-xl
                                  text-gray-600 dark:text-gray-300 bg-white dark:bg-gray-700 text-sm
                                  hover:bg-gray-50 dark:hover:bg-gray-600
                                  focus:outline-none focus:ring-2 focus:ring-gray-500 dark:focus:ring-gray-400 focus:ring-offset-2
                                  transition-all duration-200">
                            Clear Filters
                        </a>
                        <button type="submit" 
                                class="inline-flex items-center px-5 py-2 bg-gradient-to-r from-gray-800 to-gray-900 dark:from-gray-700 dark:to-gray-800 
                                       text-white rounded-xl font-medium text-sm
                                       border border-transparent
                                       hover:from-gray-700 hover:to-gray-800 dark:hover:from-gray-600 dark:hover:to-gray-700
                                       focus:outline-none focus:ring-2 focus:ring-gray-500 dark:focus:ring-gray-400 focus:ring-offset-2
                                       transform transition-all duration-200
                                       hover:scale-[1.02] active:scale-95">
                            Apply Filters
                        </button>
                    </div>
                </form>
            </div>
        </details>

        <div class="overflow-x-auto rounded-lg shadow-lg">
            <table id="timeEntriesTable" class="min-w-full divide-y divide-gray-200 dark:divide-gray-700 rounded-lg">
                <thead class="bg-gray-50 dark:bg-gray-700">
                    <tr>
                        <!-- Add checkbox column -->
                        <th class="px-2 py-4 text-center text-xs font-medium text-gray-600 dark:text-gray-300 uppercase tracking-wider">
                            <input type="checkbox" 
                                   id="selectAll"
                                   class="rounded border-gray-300 text-gray-600 focus:ring-gray-500 cursor-pointer">
                        </th>
                        {% if is_superuser or is_supervisor %}
                            <th class="px-2 py-4 text-center text-xs font-medium text-gray-600 dark:text-gray-300 uppercase tracking-wider">
                                <div class="flex items-center justify-center gap-2 cursor-pointer group" 
                                     onclick="window.location.href='?sort_by={% if sort_by == 'user__username' %}-{% endif %}user__username{% if search_query %}&search={{ search_query }}{% endif %}'">
                                    <span>User</span>
                                    <div class="flex flex-col">
                                        <svg class="h-3 w-3 {% if sort_by == '-user__username' %}text-gray-900{% else %}text-gray-400 group-hover:text-gray-600{% endif %}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"/>
                                        </svg>
                                        <svg class="h-3 w-3 -mt-1 {% if sort_by == 'user__username' %}text-gray-900{% else %}text-gray-400 group-hover:text-gray-600{% endif %}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                                        </svg>
                                    </div>
                                </div>
                            </th>
                        {% endif %}
                        <!-- Repeat similar header structure for other columns -->
                        <th class="px-2 py-4 text-center text-xs font-medium text-gray-600 dark:text-gray-300 uppercase tracking-wider">
                            <div class="flex items-center justify-center gap-2 cursor-pointer group"
                                 onclick="window.location.href='?sort_by={% if sort_by == '-date' %}-{% endif %}date{% if search_query %}&search={{ search_query }}{% endif %}'">
                                <span>Date</span>
                                <div class="flex flex-col">
                                    <svg class="h-3 w-3 {% if sort_by == '-date' %}text-gray-900{% else %}text-gray-400 group-hover:text-gray-600{% endif %}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"/>
                                    </svg>
                                    <svg class="h-3 w-3 -mt-1 {% if sort_by == 'date' %}text-gray-900{% else %}text-gray-400 group-hover:text-gray-600{% endif %}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                                    </svg>
                                </div>
                            </div>
                        </th>
                        <!-- Static headers -->
                        <th class="px-2 py-4 text-center text-xs font-medium text-gray-600 dark:text-gray-300 uppercase tracking-wider">Labor Description</th>
                        <th class="px-2 py-4 text-center text-xs font-medium text-gray-600 dark:text-gray-300 uppercase tracking-wider">Job Description</th>
                        <!-- Sortable Hours column -->
                        <th class="px-2 py-4 text-center text-xs font-medium text-gray-600 dark:text-gray-300 uppercase tracking-wider">
                            <div class="flex items-center justify-center gap-2 cursor-pointer group"
                                 onclick="window.location.href='?sort_by={% if sort_by == '-hours_for_the_day' %}-{% endif %}hours_for_the_day{% if search_query %}&search={{ search_query }}{% endif %}'">
                                <span>Hours</span>
                                <div class="flex flex-col">
                                    <svg class="h-3 w-3 {% if sort_by == '-hours_for_the_day' %}text-gray-900{% else %}text-gray-400 group-hover:text-gray-600{% endif %}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 15l7-7 7 7"/>
                                    </svg>
                                    <svg class="h-3 w-3 -mt-1 {% if sort_by == 'hours_for_the_day' %}text-gray-900{% else %}text-gray-400 group-hover:text-gray-600{% endif %}" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                                    </svg>
                                </div>
                            </div>
                        </th>
                        <th class="px-2 py-3 text-center text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                            <div class="flex items-center justify-center space-x-1 cursor-pointer group"
                                 onclick="window.location.href='?sort_by={% if sort_by == '-total_miles' %}-{% endif %}total_miles{% if search_query %}&search={{ search_query }}{% endif %}'">
                                <span>Miles</span>
                                <div class="flex flex-col">
                                    <i data-lucide="chevron-up" class="h-3 w-3 {% if sort_by == '-total_miles' %}text-blue-600{% else %}text-gray-400 group-hover:text-gray-600{% endif %}"></i>
                                    <i data-lucide="chevron-down" class="h-3 w-3 -mt-1 {% if sort_by == 'total_miles' %}text-blue-600{% else %}text-gray-400 group-hover:text-gray-600{% endif %}"></i>
                                </div>
                            </div>
                        </th>
                        <th class="px-2 py-3 text-center text-xs font-medium text-gray-500 dark:text-gray-300 uppercase tracking-wider">
                            <div class="flex items-center justify-center space-x-1 cursor-pointer group"
                                 onclick="window.location.href='?sort_by={% if sort_by == '-approval__status' %}-{% endif %}approval__status{% if search_query %}&search={{ search_query }}{% endif %}'">
                                <span>Status</span>
                                <div class="flex flex-col">
                                    <i data-lucide="chevron-up" class="h-3 w-3 {% if sort_by == '-approval__status' %}text-blue-600{% else %}text-gray-400 group-hover:text-gray-600{% endif %}"></i>
                                    <i data-lucide="chevron-down" class="h-3 w-3 -mt-1 {% if sort_by == 'approval__status' %}text-blue-600{% else %}text-gray-400 group-hover:text-gray-600{% endif %}"></i>
                                </div>
                            </div>
                        </th>
                        <!-- Continue similar pattern for Miles and Status -->
                        <th class="px-8 py-4 text-center text-xs font-medium text-gray-600 dark:text-gray-300 uppercase tracking-wider">Actions</th>
                    </tr>
                </thead>
                <tbody class="bg-white dark:bg-gray-800 divide-y divide-gray-100 dark:divide-gray-700">
                    {% for entry in page_obj %}
                        {% with jobs_count=entry.jobs.count %}
                        {% for job in entry.jobs.all %}
                            <tr class="hover:bg-gray-50 dark:hover:bg-gray-700/50 transition-colors duration-150">
                                {% if forloop.first %}
                                    <!-- Add checkbox cell -->
                                    <td class="px-2 py-5 whitespace-nowrap text-center" rowspan="{{ jobs_count }}">
                                        {% if not entry.approval or entry.approval.status == 'rejected' %}
                                        <input type="checkbox" 
                                               name="entry_ids" 
                                               value="{{ entry.id }}"
                                               class="entry-checkbox rounded border-gray-300 text-gray-600 focus:ring-gray-500 cursor-pointer">
                                        {% endif %}
                                    </td>
                                    {% if is_superuser or is_supervisor %}
                                        <td class="px-8 py-5 whitespace-nowrap" rowspan="{{ jobs_count }}">
                                            <div class="flex items-center">
                                                <div class="w-8 h-8 rounded-full bg-gray-100 dark:bg-gray-700 text-gray-600 dark:text-gray-300 flex items-center justify-center font-medium text-sm mr-3">
                                                    {{ entry.user.username|make_list|first|upper }}
                                                </div>
                                                <span class="text-sm text-gray-900 dark:text-white">{{ entry.user.username }}</span>
                                            </div>
                                        </td>
                                    {% endif %}
                                    <td class="px-8 py-5 whitespace-nowrap text-sm text-gray-900 dark:text-white" rowspan="{{ jobs_count }}">{{ entry.date }}</td>
                                {% endif %}
                                <td class="px-8 py-5 whitespace-nowrap">
                                    <div class="text-sm text-gray-900 dark:text-white">{{ job.labor_code_description }}</div>
                                </td>
                                <td class="px-8 py-5 whitespace-nowrap">
                                    <div class="text-sm text-gray-900 dark:text-white">{{ job.job_description }}</div>
                                </td>
                                {% if forloop.first %}
                                    <td class="px-8 py-5 whitespace-nowrap text-sm text-gray-900 dark:text-white" rowspan="{{ jobs_count }}">{{ entry.hours_for_the_day }}</td>
                                    <td class="px-8 py-5 whitespace-nowrap text-sm text-gray-900 dark:text-white" rowspan="{{ jobs_count }}">{{ entry.total_miles }}</td>
                                    <td class="px-8 py-5 whitespace-nowrap" rowspan="{{ jobs_count }}">
                                        {% if entry.approval %}
                                            <span class="px-3 py-1.5 inline-flex text-xs leading-5 font-semibold rounded-full 
                                                {% if entry.approval.status == 'approved' %}
                                                    bg-green-100 dark:bg-green-900 text-green-700 dark:text-green-300 border border-green-200/50 dark:border-green-800/50
                                                {% elif entry.approval.status == 'rejected' %}
                                                    bg-red-100 dark:bg-red-900 text-red-700 dark:text-red-300 border border-red-200/50 dark:border-red-800/50
                                                {% else %}
                                                    bg-amber-100 dark:bg-amber-900 text-amber-700 dark:text-amber-300 border border-amber-200/50 dark:border-amber-800/50
                                                {% endif %}">
                                                {% if entry.approval.status == 'approved' %}
                                                    <svg class="w-4 h-4 mr-1.5 inline-block" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"/>
                                                    </svg>
                                                {% elif entry.approval.status == 'rejected' %}
                                                    <svg class="w-4 h-4 mr-1.5 inline-block" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"/>
                                                    </svg>
                                                {% else %}
                                                    <svg class="w-4 h-4 mr-1.5 inline-block" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                                    </svg>
                                                {% endif %}
                                                {{ entry.approval.status|title }}
                                            </span>
                                        {% else %}
                                            <span class="px-3 py-1.5 inline-flex items-center text-xs leading-5 font-semibold rounded-full bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 border border-gray-200/50 dark:border-gray-600/50">
                                                <svg class="w-4 h-4 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                                                </svg>
                                                Not Submitted
                                            </span>
                                        {% endif %}
                                    </td>
                                    <td class="px-8 py-5 whitespace-nowrap text-right space-x-2" rowspan="{{ jobs_count }}">
                                        <a href="{% url 'timesheets:time_entry_detail' entry.pk %}" 
                                           class="inline-flex items-center px-3 py-1.5 bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 
                                                  rounded-lg text-sm font-medium hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors">
                                            <svg class="w-4 h-4 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"/>
                                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z"/>
                                            </svg>
                                        </a>
                                        {% if not entry.approval or entry.approval.status == 'rejected' %}
                                            <a href="{% url 'timesheets:time_entry_edit' entry.pk %}" 
                                               class="inline-flex items-center px-3 py-1.5 bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 
                                                      rounded-lg text-sm font-medium hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors">
                                                <svg class="w-4 h-4 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z"/>
                                                </svg>
                                            </a>
                                            <a href="{% url 'timesheets:time_entry_delete' entry.pk %}" 
                                               class="inline-flex items-center px-3 py-1.5 bg-red-100 dark:bg-red-900 text-red-700 dark:text-red-300 
                                                      rounded-lg text-sm font-medium hover:bg-red-200 dark:hover:bg-red-800 transition-colors">
                                                <svg class="w-4 h-4 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                                                </svg>
                                            </a>
                                        {% endif %}
                                        {% if not entry.approval and not is_superuser and not is_supervisor %}
                                            <a href="{% url 'timesheets:submit_for_approval' entry.pk %}" 
                                               class="inline-flex items-center px-3 py-1.5 bg-green-100 dark:bg-green-900 text-green-700 dark:text-green-300 
                                                      rounded-lg text-sm font-medium hover:bg-green-200 dark:hover:bg-green-800 transition-colors">
                                                <svg class="w-4 h-4 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"/>
                                                </svg>
                                            </a>
                                        {% endif %}
                                        {% if entry.attachment %}
<a href="{{ entry.attachment.url }}" 
   class="inline-flex items-center px-3 py-1.5 bg-gray-100 dark:bg-gray-700 text-gray-700 dark:text-gray-300 
          rounded-lg text-sm font-medium hover:bg-gray-200 dark:hover:bg-gray-600 transition-colors"
   target="_blank">
    <svg class="w-4 h-4 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
              d="M15.172 7l-6.586 6.586a2 2 0 102.828 2.828l6.414-6.586a4 4 0 00-5.656-5.656l-6.415 6.585a6 6 0 108.486 8.486L20.5 13"/>
    </svg>
</a>
{% endif %}
                                    </td>
                                {% endif %}
                            </tr>
                        {% endfor %}
                        {% endwith %}
                    {% endfor %}
                </tbody>
            </table>
        </div>

        <!-- Add Batch Actions Bar -->
        <div id="batchActionsBar" 
             class="hidden fixed bottom-4 left-1/2 transform -translate-x-1/2 
                    bg-white dark:bg-gray-800 shadow-lg rounded-lg border border-gray-200 dark:border-gray-700 px-4 py-3 
                    flex items-center space-x-4">
            <span id="selectedCount" class="text-sm text-gray-600 dark:text-gray-300">0 items selected</span>
            <button id="batchDeleteBtn"
                    class="inline-flex items-center px-4 py-2 border border-transparent 
                           text-sm font-medium rounded-md text-white bg-red-600 
                           hover:bg-red-700 focus:outline-none focus:ring-2 
                           focus:ring-offset-2 focus:ring-red-500">
                <svg class="w-4 h-4 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                          d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
                </svg>
                Delete Selected
            </button>
        </div>

        {% if page_obj.paginator.num_pages > 1 %}
        <div class="mt-4 flex items-center justify-between text-gray-700 dark:text-gray-300">
            <div class="flex-1 flex justify-between items-center">
                <div>
                    <p class="text-sm text-gray-700 dark:text-gray-300">
                        Showing
                        <span class="font-medium">{{ page_obj.start_index }}</span>
                        to
                        <span class="font-medium">{{ page_obj.end_index }}</span>
                        of
                        <span class="font-medium">{{ page_obj.paginator.count }}</span>
                        entries
                    </p>
                </div>
                <div class="space-x-2">
                    {% if page_obj.has_previous %}
                        <a href="?page=1{% if search_query %}&search={{ search_query }}{% endif %}{% if sort_by %}&sort_by={{ sort_by }}{% endif %}" 
                           class="px-3 py-2 border rounded-md text-sm font-medium text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600">
                            First
                        </a>
                        <a href="?page={{ page_obj.previous_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}{% if sort_by %}&sort_by={{ sort_by }}{% endif %}"
                           class="px-3 py-2 border rounded-md text-sm font-medium text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600">
                            Previous
                        </a>
                    {% endif %}
                    
                    <span class="px-3 py-2 border rounded-md text-sm font-medium text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-700">
                        Page {{ page_obj.number }} of {{ page_obj.paginator.num_pages }}
                    </span>

                    {% if page_obj.has_next %}
                        <a href="?page={{ page_obj.next_page_number }}{% if search_query %}&search={{ search_query }}{% endif %}{% if sort_by %}&sort_by={{ sort_by }}{% endif %}"
                           class="px-3 py-2 border rounded-md text-sm font-medium text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600">
                            Next
                        </a>
                        <a href="?page={{ page_obj.paginator.num_pages }}{% if search_query %}&search={{ search_query }}{% endif %}{% if sort_by %}&sort_by={{ sort_by }}{% endif %}"
                           class="px-3 py-2 border rounded-md text-sm font-medium text-gray-700 dark:text-gray-300 bg-white dark:bg-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600">
                            Last
                        </a>
                    {% endif %}
                </div>
            </div>
        </div>
        {% endif %}
    </div>
</div>

<!-- Add JavaScript for handling selections and batch delete -->
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Get references to key elements
        const selectAllCheckbox = document.getElementById('selectAll');
        const entryCheckboxes = document.getElementsByClassName('entry-checkbox');
        const batchActionsBar = document.getElementById('batchActionsBar');
        const selectedCountSpan = document.getElementById('selectedCount');
        const batchDeleteBtn = document.getElementById('batchDeleteBtn');
        const timeEntriesTable = document.getElementById('timeEntriesTable');
    
        // Get CSRF token from cookies
        function getCSRFToken() {
            const name = 'csrftoken';
            let cookieValue = null;
            if (document.cookie && document.cookie !== '') {
                const cookies = document.cookie.split(';');
                for (let i = 0; i < cookies.length; i++) {
                    const cookie = cookies[i].trim();
                    if (cookie.substring(0, name.length + 1) === (name + '=')) {
                        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                        break;
                    }
                }
            }
            return cookieValue;
        }
    
        // Initialize the batch actions bar
        function initializeBatchActions() {
            // Handle "Select All" checkbox
            selectAllCheckbox?.addEventListener('change', function() {
                Array.from(entryCheckboxes).forEach(checkbox => {
                    checkbox.checked = selectAllCheckbox.checked;
                });
                updateBatchActionsBar();
            });
    
            // Handle individual checkboxes
            Array.from(entryCheckboxes).forEach(checkbox => {
                checkbox.addEventListener('change', function() {
                    updateBatchActionsBar();
                    updateSelectAllCheckbox();
                });
            });
    
            // Initialize batch delete button
            batchDeleteBtn?.addEventListener('click', handleBatchDelete);
    
            // Initial update of the batch actions bar
            updateBatchActionsBar();
        }
    
        // Update the select all checkbox state
        function updateSelectAllCheckbox() {
            if (!selectAllCheckbox) return;
            
            const totalCheckboxes = entryCheckboxes.length;
            const checkedCheckboxes = Array.from(entryCheckboxes).filter(cb => cb.checked).length;
            
            selectAllCheckbox.checked = totalCheckboxes > 0 && totalCheckboxes === checkedCheckboxes;
            selectAllCheckbox.indeterminate = checkedCheckboxes > 0 && checkedCheckboxes < totalCheckboxes;
        }
    
        // Update the batch actions bar visibility and count
        function updateBatchActionsBar() {
            const selectedCount = Array.from(entryCheckboxes)
                .filter(checkbox => checkbox.checked).length;
            
            if (selectedCount > 0) {
                batchActionsBar.classList.remove('hidden');
                selectedCountSpan.textContent = `${selectedCount} item${selectedCount === 1 ? '' : 's'} selected`;
            } else {
                batchActionsBar.classList.add('hidden');
            }
        }
    
        // Handle the batch delete operation
        async function handleBatchDelete() {
    const selectedCheckboxes = Array.from(entryCheckboxes).filter(checkbox => checkbox.checked);
    const selectedIds = selectedCheckboxes.map(checkbox => checkbox.value);

    if (selectedIds.length === 0) {
        showAlert('Please select items to delete', 'error');
        return;
    }

    if (!confirm(`Are you sure you want to delete ${selectedIds.length} selected item(s)?`)) {
        return;
    }

    // Disable delete button to prevent double submission
    batchDeleteBtn.disabled = true;
    batchDeleteBtn.classList.add('opacity-50', 'cursor-not-allowed');

    try {
        // Show loading state
        const originalButtonContent = batchDeleteBtn.innerHTML;
        batchDeleteBtn.innerHTML = `
            <svg class="animate-spin h-5 w-5 mr-2" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4" fill="none"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            Deleting...
        `;

        const response = await fetch('{% url "timesheets:batch_delete" %}', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': getCSRFToken(),
            },
            body: JSON.stringify({ entry_ids: selectedIds }),
            credentials: 'same-origin'
        });

        const result = await response.json();

        if (response.ok) {
            // Remove the deleted rows with animation
            selectedCheckboxes.forEach(checkbox => {
                const row = checkbox.closest('tr');
                if (row) {
                    const rowspan = parseInt(checkbox.closest('td').getAttribute('rowspan')) || 1;
                    let currentRow = row;
                    
                    for (let i = 0; i < rowspan; i++) {
                        if (currentRow) {
                            currentRow.style.transition = 'all 0.3s ease-out';
                            currentRow.style.opacity = '0';
                            currentRow.style.transform = 'translateX(20px)';
                            const rowToRemove = currentRow;
                            setTimeout(() => rowToRemove.remove(), 300);
                            currentRow = currentRow.nextElementSibling;
                        }
                    }
                }
            });

            showAlert(result.message, 'success');
            updateBatchActionsBar();
            updateSelectAllCheckbox();
            updatePageCounts(result.deleted_count);

            // Check if table is empty
            setTimeout(() => {
                const tbody = timeEntriesTable.querySelector('tbody');
                if (tbody.children.length === 0) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="8" class="px-6 py-4 text-center text-gray-500">
                                No entries found
                            </td>
                        </tr>
                    `;
                }
            }, 350);
        } else {
            showAlert(result.message || 'Error deleting entries', 'error');
        }
    } catch (error) {
        console.error('Error:', error);
        showAlert('An unexpected error occurred', 'error');
    } finally {
        // Reset delete button state
        batchDeleteBtn.disabled = false;
        batchDeleteBtn.classList.remove('opacity-50', 'cursor-not-allowed');
        batchDeleteBtn.innerHTML = `
            <svg class="w-4 h-4 mr-1.5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"/>
            </svg>
            Delete Selected
        `;
    }
}
    
        // Restore removed rows in case of error
        function restoreRows(removedRows) {
            removedRows.forEach(({rows, nextSibling}, id) => {
                rows.forEach(row => {
                    row.style.opacity = '0';
                    if (nextSibling) {
                        timeEntriesTable.querySelector('tbody').insertBefore(row, nextSibling);
                    } else {
                        timeEntriesTable.querySelector('tbody').appendChild(row);
                    }
                    // Trigger reflow to enable animation
                    row.offsetHeight;
                    row.style.opacity = '1';
                });
            });
        }
    
        // Update page counts without reload
        function updatePageCounts(deletedCount) {
            // Update total entries count if it exists
            const totalEntriesElement = document.querySelector('.total-entries');
            if (totalEntriesElement) {
                const currentTotal = parseInt(totalEntriesElement.textContent);
                totalEntriesElement.textContent = Math.max(0, currentTotal - deletedCount);
            }
    
            // Update pagination info if it exists
            const paginationInfo = document.querySelector('.pagination-info');
            if (paginationInfo) {
                const matches = paginationInfo.textContent.match(/Showing (\d+) to (\d+) of (\d+)/);
                if (matches) {
                    const [, start, end, total] = matches;
                    const newTotal = Math.max(0, parseInt(total) - deletedCount);
                    const newEnd = Math.min(parseInt(end), newTotal);
                    paginationInfo.textContent = `Showing ${start} to ${newEnd} of ${newTotal}`;
                }
            }
        }
    
        // Show alert message
        function showAlert(message, type = 'success') {
            const alertDiv = document.createElement('div');
            alertDiv.className = `fixed top-4 right-4 p-4 rounded-lg ${
                type === 'success' ? 'bg-green-100 text-green-700' : 'bg-red-100 text-red-700'
            } shadow-lg z-50 transition-opacity duration-300`;
            
            alertDiv.innerHTML = `
                <div class="flex items-center">
                    ${type === 'success' ? 
                        '<svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>' :
                        '<svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>'
                    }
                    <span>${message}</span>
                </div>
            `;
            
            document.body.appendChild(alertDiv);
            
            // Fade in
            setTimeout(() => alertDiv.style.opacity = '1', 10);
            
            // Fade out and remove
            setTimeout(() => {
                alertDiv.style.opacity = '0';
                setTimeout(() => alertDiv.remove(), 300);
            }, 3000);
        }
    
        // Initialize all functionality
        initializeBatchActions();
    
        // Details Toggle Script
        document.querySelectorAll('details').forEach((detail) => {
            // Remove the 'open' attribute to start collapsed
            detail.removeAttribute('open');
            
            const summary = detail.querySelector('summary');
            const arrow = summary.querySelector('svg');
            
            // Initialize arrow to point down (collapsed state)
            arrow.classList.add('rotate-180');
            
            detail.addEventListener('toggle', () => {
                if (detail.open) {
                    // When opening, arrow points up
                    arrow.classList.remove('rotate-180');
                } else {
                    // When closing, arrow points down
                    arrow.classList.add('rotate-180');
                }
            });
        });
    });
    </script>
{% endblock %}
