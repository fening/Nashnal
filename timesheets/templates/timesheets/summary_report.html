{% extends 'timesheets/base.html' %}

{% block title %}<h1 class="text-xl font-semibold">Summary Report</h1>{% endblock %}

{% block content %}
{% load custom_filters %}
<style>
    /* Remove the default triangle marker from details/summary */
    details > summary {
        list-style: none;
    }
    details > summary::-webkit-details-marker {
        display: none;
    }
        /* Remove the default triangle marker from details/summary */
        details > summary {
            list-style: none;
        }
        details > summary::-webkit-details-marker {
            display: none;
        }
    
        /* Print styles */
        @media print {
            .no-print {
                display: none !important;
            }
            .print-only {
                display: block !important;
            }
            /* Hide non-printable elements */
            header, footer, nav, .no-print, .screen-only, #sidebar, #sidebarToggle, #closeSidebar {
                display: none !important;
            }
            /* Set page to landscape */
            @page {
                size: A4 landscape;
                margin: 1cm;
            }
            /* Reset layout for printing */
            body, html {
                background: white !important;
                margin: 0 !important;
                padding: 0 !important;
                width: 210mm !important; /* A4 width */
                height: 297mm !important; /* A4 height */
                overflow: visible !important;
                font-size: 0.9em; /* Reduce font size slightly */
            }
            /* Reset main content positioning */
            #mainContent {
                margin-left: 0 !important;
                padding: 0 !important;
                width: 100% !important;
                position: absolute!important;
                left: 0 !important;
                top: 0 !important;
            }
        }
        @media screen {
            .print-only {
                display: none;
            }
        }
</style>
<div class="p-6 max-w-8xl mx-auto">
    <!-- Filter Form -->
    <details class="group bg-white shadow-xl rounded-2xl overflow-hidden transition-all duration-300 hover:shadow-2xl screen-only">
        <!-- Summary section -->
        <summary class="px-6 py-4 border-b border-gray-100 cursor-pointer hover:bg-gray-50/50 transition-all">
            <div class="flex items-center justify-between">
                <h2 class="text-lg font-semibold text-gray-800">Filter Options</h2>
                <svg class="w-5 h-5 text-gray-500 transform transition-transform duration-200" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                </svg>
            </div>
        </summary>
        
        <!-- Content section -->
        <div class="px-3 py-2">
            <form method="GET" action="{% url 'timesheets:user_summary_report' %}" class="mb-1">
                <div class="bg-white p-4">
                    <!-- Grid -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        {% if is_superuser or is_supervisor %}
                        <div class="space-y-0.5">
                            <label for="user-select" class="text-sm font-medium text-gray-600">Select User</label>
                            <div class="relative">
                                <select name="user" 
                                        id="user-select" 
                                        class="w-full pl-3 pr-8 py-2 bg-gray-50 border border-gray-200 rounded-xl
                                               text-gray-700 appearance-none
                                               focus:outline-none focus:ring-2 focus:ring-gray-500 focus:border-transparent
                                               focus:bg-white
                                               cursor-pointer
                                               transition-all duration-200">
                                    <option value="">All Users</option>
                                    {% for user in all_users %}
                                        <option value="{{ user.id }}" {% if selected_user and user.id == selected_user.id %}selected{% endif %}>
                                            {{ user.first_name }} {{ user.last_name }}
                                        </option>
                                    {% endfor %}
                                </select>
                                <div class="absolute inset-y-0 right-0 flex items-center pr-2 pointer-events-none">
                                    <svg class="w-5 h-5 text-gray-400" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/>
                                    </svg>
                                </div>
                            </div>
                        </div>
                        {% endif %}

                        <div class="space-y-0.5">
                            <label for="week-start" class="text-sm font-medium text-gray-600">Week Start Date</label>
                            <input type="date" 
                                   name="week_start" 
                                   id="week-start" 
                                   value="{{ week_start|date:'Y-m-d' }}"
                                   class="w-full pl-3 pr-3 py-2 bg-gray-50 border border-gray-200 rounded-xl
                                          text-gray-900
                                          focus:outline-none focus:ring-2 focus:ring-gray-500 focus:border-transparent
                                          focus:bg-white
                                          transition-all duration-200">
                        </div>
                    </div>

                    <!-- Filter buttons row -->
                    <div class="mt-4 flex justify-end space-x-4">
                        <button type="submit" 
                        class="inline-flex items-center px-4 py-2.5 bg-gradient-to-r from-gray-800 to-gray-900 
                        text-white rounded-xl font-medium
                        border border-transparent
                        hover:from-gray-700 hover:to-gray-800
                        focus:outline-none
                        transform transition-all duration-200
                        hover:scale-[1.02] active:scale-95
                        no-print">
                            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/>
                            </svg>
                            Apply Filters
                        </button>
                        {% if request.GET.user or request.GET.week_start %}
                        <a href="{{ request.path }}" 
                           class="inline-flex items-center px-4 py-2 border border-gray-200 rounded-xl
                                  text-gray-600 bg-white
                                  hover:bg-gray-50
                                  focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-offset-2
                                  transition-all duration-200">
                            <svg class="w-4 h-4 mr-2 text-gray-500" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                                      d="M6 18L18 6M6 6l12 12"/>
                            </svg>
                            Clear Filters
                        </a>
                        {% endif %}
                    </div>
                </div>
            </form>
        </div>
    </details>
</div>


    <!-- Report Header -->
    <h2 class="px-2 py-4 text-xl font-semibold mb-6 text-gray-800">
        Report for {{ selected_user.first_name }} {{ selected_user.last_name }} 
        (Week of {{ week_start|date:'M d, Y' }} to {{ week_end|date:'M d, Y' }})
    </h2>

<!-- Weekly Hours Table -->
<div class="mb-8 overflow-x-auto bg-white shadow-xl rounded-2xl">
    <table class="min-w-full divide-y divide-gray-100">
        <thead class="bg-gray-50/75">
            <tr>
                <th scope="col" class="px-8 py-4 text-left text-xs font-medium text-gray-600 uppercase tracking-wider whitespace-nowrap">Project No</th>
                <th scope="col" class="px-8 py-4 text-left text-xs font-medium text-gray-600 uppercase tracking-wider whitespace-nowrap">Client No</th>
                <th scope="col" class="px-8 py-4 text-left text-xs font-medium text-gray-600 uppercase tracking-wider whitespace-nowrap">Project Name</th>
                <th scope="col" class="px-8 py-4 text-left text-xs font-medium text-gray-600 uppercase tracking-wider whitespace-nowrap">Labor Code</th>
                <!-- Days of Week -->
                {% for day, date in week_days.items %}
                <th scope="col" class="px-6 py-4 text-center text-xs font-medium text-gray-600 uppercase tracking-wider">
                    <div class="flex flex-col items-center">
                        <span class="text-gray-400 text-[10px]">{{ day|slice:":3" }}</span>
                        <span class="mt-1">{{ date|date:"d" }}</span>
                    </div>
                </th>
                {% endfor %}
                <th scope="col" class="px-8 py-4 text-center text-xs font-medium text-gray-600 uppercase tracking-wider whitespace-nowrap">Total Hours</th>
            </tr>
        </thead>
        <tbody class="bg-white divide-y divide-gray-50">
            {% for labor_code, data in weekly_hours.items %}
            <tr class="hover:bg-gray-50/50 transition-colors duration-150">
                <td class="px-8 py-5 whitespace-nowrap">
                    <div class="text-sm font-medium text-gray-900">{{ data.job.project_number }}</div>
                </td>
                <td class="px-8 py-5 whitespace-nowrap">
                    <div class="text-sm text-gray-900">{{ data.job.client_number }}</div>
                </td>
                <td class="px-8 py-5 whitespace-nowrap">
                    <div class="text-sm text-gray-900">{{ data.description }}</div>
                </td>
                <td class="px-8 py-5 whitespace-nowrap">
                    <div class="text-sm text-gray-900">{{ labor_code }} - {{ data.labor_code_description }}</div>
                </td>
                <td class="px-6 py-5 whitespace-nowrap text-center">
                    <div class="text-sm text-gray-900">{{ data.hours.Sunday|default:"--" }}</div>
                </td>
                <td class="px-6 py-5 whitespace-nowrap text-center">
                    <div class="text-sm text-gray-900">{{ data.hours.Monday|default:"--" }}</div>
                </td>
                <td class="px-6 py-5 whitespace-nowrap text-center">
                    <div class="text-sm text-gray-900">{{ data.hours.Tuesday|default:"--" }}</div>
                </td>
                <td class="px-6 py-5 whitespace-nowrap text-center">
                    <div class="text-sm text-gray-900">{{ data.hours.Wednesday|default:"--" }}</div>
                </td>
                <td class="px-6 py-5 whitespace-nowrap text-center">
                    <div class="text-sm text-gray-900">{{ data.hours.Thursday|default:"--" }}</div>
                </td>
                <td class="px-6 py-5 whitespace-nowrap text-center">
                    <div class="text-sm text-gray-900">{{ data.hours.Friday|default:"--" }}</div>
                </td>
                <td class="px-6 py-5 whitespace-nowrap text-center">
                    <div class="text-sm text-gray-900">{{ data.hours.Saturday|default:"--" }}</div>
                </td>
                <td class="px-8 py-5 whitespace-nowrap text-center">
                    <div class="text-sm font-medium text-gray-900">
                        {{ data.hours.Sunday|add:data.hours.Monday|add:data.hours.Tuesday|add:data.hours.Wednesday|add:data.hours.Thursday|add:data.hours.Friday|add:data.hours.Saturday }}
                    </div>
                </td>
            </tr>
            {% endfor %}

            <!-- Daily Totals Row -->
            <tr class="bg-gray-50/75 font-medium border-t-2 border-gray-200">
                <td colspan="4" class="px-8 py-5 whitespace-nowrap">
                    <div class="text-sm font-semibold text-gray-900">Total Daily Hours</div>
                </td>
                <td class="px-6 py-5 whitespace-nowrap text-center">
                    <div class="text-sm font-semibold text-gray-900">{{ daily_totals.Sunday|default:"0" }}</div>
                </td>
                <td class="px-6 py-5 whitespace-nowrap text-center">
                    <div class="text-sm font-semibold text-gray-900">{{ daily_totals.Monday|default:"0" }}</div>
                </td>
                <td class="px-6 py-5 whitespace-nowrap text-center">
                    <div class="text-sm font-semibold text-gray-900">{{ daily_totals.Tuesday|default:"0" }}</div>
                </td>
                <td class="px-6 py-5 whitespace-nowrap text-center">
                    <div class="text-sm font-semibold text-gray-900">{{ daily_totals.Wednesday|default:"0" }}</div>
                </td>
                <td class="px-6 py-5 whitespace-nowrap text-center">
                    <div class="text-sm font-semibold text-gray-900">{{ daily_totals.Thursday|default:"0" }}</div>
                </td>
                <td class="px-6 py-5 whitespace-nowrap text-center">
                    <div class="text-sm font-semibold text-gray-900">{{ daily_totals.Friday|default:"0" }}</div>
                </td>
                <td class="px-6 py-5 whitespace-nowrap text-center">
                    <div class="text-sm font-semibold text-gray-900">{{ daily_totals.Saturday|default:"0" }}</div>
                </td>
                <td class="px-8 py-5 whitespace-nowrap text-center">
                    <div class="text-sm font-semibold text-gray-900">
                        {{ daily_totals.Sunday|add:daily_totals.Monday|add:daily_totals.Tuesday|add:daily_totals.Wednesday|add:daily_totals.Thursday|add:daily_totals.Friday|add:daily_totals.Saturday }}
                    </div>
                </td>
            </tr>
        </tbody>
    </table>
</div>



    <!-- Labor Code Section - Hidden by default, visible when printing -->
    <div class="bg-white shadow-md rounded-lg overflow-hidden mb-8 hidden print-only">
        <table class="min-w-full divide-y divide-gray-300 ">
            <thead class="bg-gray-300">
                <tr>
                    <th colspan="2" class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-r text-center ">Field Technician & Engineering Codes</th>
                    <th colspan="2" class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider border-r text-center ">Lab Service Codes</th>
                    <th colspan="6" class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider text-center ">Time Sheet Summary</th>
                </tr>
            </thead>
            <tbody class="bg-white divide-y divide-gray-300 ">
                <!-- Row 1 -->
                <tr class="hover:bg-gray-300">
                    <td class="px-4 py-1 text-sm text-gray-900 border-r">1. Project Management/P.E.</td>
                    <td class="px-4 py-1 text-sm text-gray-900 border-r ">13. Concrete Lab</td>
                    <td class="px-4 py-1 text-sm text-gray-900 border-r ">25. Moisture Content</td>
                    <td class="px-4 py-1 text-sm text-gray-900 border-r ">37. Modified Proctor 4" Mold</td>
                    <td colspan="3" class="px-4 py-1 text-sm font-semibold text-gray-900 ">Total Regular Hours</td>
                    <td colspan="3" class="px-4 py-1 text-sm font-semibold text-gray-900">{{ total_regular_hours }}</td>
                </tr>
                <!-- Row 2 -->
                <tr class="hover:bg-gray-300">
                    <td class="px-4 py-1 text-sm text-gray-900 border-r">2. Senior Engineer/P.E.</td>
                    <td class="px-4 py-1 text-sm text-gray-900 border-r">14. Concrete Coring</td>
                    <td class="px-4 py-1 text-sm text-gray-900 border-r">26. Particle Size Analysis</td>
                    <td class="px-4 py-1 text-sm text-gray-900 border-r">38. Modified Proctor 6" Mold</td>
                    <td colspan="3" class="px-4 py-1 text-sm font-semibold text-gray-900">Total Overtime Hours</td>
                    <td colspan="3" class="px-4 py-1 text-sm font-semibold text-gray-900">{{ total_overtime_hours }}</td>
                </tr>
                <!-- Row 3 -->
                <tr class="hover:bg-gray-300">
                    <td class="px-4 py-1 text-sm text-gray-900 border-r">3. Project Engineer</td>
                    <td class="px-4 py-1 text-sm text-gray-900 border-r">15. Windsor Probe/Pin</td>
                    <td class="px-4 py-1 text-sm text-gray-900 border-r">27. Hydrometer</td>
                    <td class="px-4 py-1 text-sm text-gray-900 border-r">39. Unconsolidated Triaxle Shear Test</td>
                    <td colspan="3" class="px-4 py-1 text-sm font-semibold text-gray-900">Double Time Hours</td>
                    <td colspan="3" class="px-4 py-1 text-sm font-semibold text-gray-900">{{ total_double_time_hours }}</td>
                </tr>
                <!-- Row 4 -->
                <tr class="hover:bg-gray-300">
                    <td class="px-4 py-1 text-sm text-gray-900 border-r">4. Lab Manager</td>
                    <td class="px-4 py-1 text-sm text-gray-900 border-r">16. Schmidt Hammer</td>
                    <td class="px-4 py-1 text-sm text-gray-900 border-r">28. Atterberg Limits</td>
                    <td class="px-4 py-1 text-sm text-gray-900 border-r">40. Consolidated Triaxle Shear Test</td>
                    <td colspan="3" class="px-4 py-1 text-sm font-semibold text-gray-900">Grand Total Hours</td>
                    <td colspan="3" class="px-4 py-1 text-sm font-semibold text-gray-900">{{ grand_total_hours }}</td>
                </tr>
                <!-- Row 5 -->
                <tr class="hover:bg-gray-300">
                    <td class="px-4 py-1 text-sm text-gray-900 border-r">5. Laboratory Technician</td>
                    <td class="px-4 py-1 text-sm text-gray-900 border-r">17. Ground Penetrating Radar</td>
                    <td class="px-4 py-1 text-sm text-gray-900 border-r">29. Specific Gravity</td>
                    <td class="px-4 py-1 text-sm text-gray-900 border-r">41. Unconfined Compression</td>
                    <td colspan="6" class="px-4 py-1"></td>
                </tr>
                <!-- Row 6 -->
                <tr class="hover:bg-gray-300">
                    <td class="px-4 py-1 text-sm text-gray-900 border-r">6. Field Engineer</td>
                    <td class="px-4 py-1 text-sm text-gray-900 border-r">18. Floor Flatness</td>
                    <td class="px-4 py-1 text-sm text-gray-900 border-r">30. Organic Content</td>
                    <td class="px-4 py-1 text-sm text-gray-900 border-r">42. One Dimensional Consolidation</td>
                    <td colspan="6" class="px-4 py-1"></td>
                </tr>
                <!-- Row 7 -->
                <tr class="hover:bg-gray-300">
                    <td class="px-4 py-1 text-sm text-gray-900 border-r">7. Field Technician Level I</td>
                    <td class="px-4 py-1 text-sm text-gray-900 border-r">19. CAD Drawing</td>
                    <td class="px-4 py-1 text-sm text-gray-900 border-r">31. Unit Weight</td>
                    <td class="px-4 py-1 text-sm text-gray-900 border-r">43. Asphalt Extraction Test</td>
                    <td colspan="6" class="px-4 py-1"></td>
                </tr>
                <!-- Row 8 -->
                <tr class="hover:bg-gray-300">
                    <td class="px-4 py-1 text-sm text-gray-900 border-r">8. Field Technician Level II</td>
                    <td class="px-4 py-1 text-sm text-gray-900 border-r">20. Administration</td>
                    <td class="px-4 py-1 text-sm text-gray-900 border-r">32. Density, Soil Particle</td>
                    <td class="px-4 py-1 text-sm text-gray-900 border-r">44. Gyratory Compaction</td>
                    <td colspan="6" class="px-4 py-1"></td>
                </tr>
                <!-- Row 9 -->
                <tr class="hover:bg-gray-300">
                    <td class="px-4 py-1 text-sm text-gray-900 border-r">9. CWI</td>
                    <td class="px-4 py-1 text-sm text-gray-900 border-r">21. Marketing</td>
                    <td class="px-4 py-1 text-sm text-gray-900 border-r">33. Fractional Organic Carbon</td>
                    <td class="px-4 py-1 text-sm text-gray-900 border-r">45. Asphalt Bulk Specific Gravity</td>
                    <td colspan="6" class="px-4 py-1"></td>
                </tr>
                <!-- Row 10 -->
                <tr class="hover:bg-gray-300">
                    <td class="px-4 py-1 text-sm text-gray-900 border-r">10. Report / Documentation Preparation</td>
                    <td class="px-4 py-1 text-sm text-gray-900 border-r">22. Clerical Support</td>
                    <td class="px-4 py-1 text-sm text-gray-900 border-r">34. Hydraulic Conductivity</td>
                    <td class="px-4 py-1 text-sm text-gray-900 border-r">46. Asphalt Apparent Specific Gravity</td>
                    <td colspan="6" class="px-4 py-1"></td>
                </tr>
                <!-- Row 11 -->
                <tr class="hover:bg-gray-300">
                    <td class="px-4 py-1 text-sm text-gray-900 border-r">11. Report / Document Quality Review</td>
                    <td class="px-4 py-1 text-sm text-gray-900 border-r">23. Training</td>
                    <td class="px-4 py-1 text-sm text-gray-900 border-r">35. Standard Proctor 4" Mold</td>
                    <td class="px-4 py-1 text-sm text-gray-900 border-r">47. pH</td>
                    <td colspan="6" class="px-4 py-1"></td>
                </tr>
                <!-- Row 12 -->
                <tr class="hover:bg-gray-300">
                    <td class="px-4 py-1 text-sm text-gray-900 border-r">12. Concrete / Sample Collection Pick-Up</td>
                    <td class="px-4 py-1 text-sm text-gray-900 border-r">24. School</td>
                    <td class="px-4 py-1 text-sm text-gray-900 border-r">36. Standard Proctor 6" Mold</td>
                    <td class="px-4 py-1 text-sm text-gray-900 border-r">48. Other</td>
                    <td colspan="6" class="px-4 py-1"></td>
                </tr>
            </tbody>
        </table>
    </div>
    
    <div class="p-4 screen-only">
        <!-- Summary Grid -->
        <div class="summary-grid grid grid-cols-1 md:grid-cols-4 gap-4">
            <!-- Regular Hours -->
            <div class="summary-card rounded-lg border border-gray-200 shadow-lg p-4 bg-white">
                <div class="flex flex-col">
                    <div class="text-sm font-medium text-gray-500 mb-1">Regular Hours</div>
                    <div class="flex items-baseline">
                        <span class="text-2xl font-semibold text-gray-900">{{ total_regular_hours }}</span>
                        <span class="ml-1 text-sm text-gray-500">hrs</span>
                    </div>
                </div>
            </div>

            <!-- Overtime Hours -->
            <div class="summary-card rounded-lg border border-gray-200 shadow-lg p-4 bg-white">
                <div class="flex flex-col">
                    <div class="text-sm font-medium text-gray-500 mb-1">Overtime Hours</div>
                    <div class="flex items-baseline">
                        <span class="text-2xl font-semibold text-gray-900">{{ total_overtime_hours }}</span>
                        <span class="ml-1 text-sm text-gray-500">hrs</span>
                    </div>
                </div>
            </div>

            <!-- Double Time Hours -->
            <div class="summary-card rounded-lg border border-gray-200 shadow-lg p-4 bg-white">
                <div class="flex flex-col">
                    <div class="text-sm font-medium text-gray-500 mb-1">Double Time Hours</div>
                    <div class="flex items-baseline">
                        <span class="text-2xl font-semibold text-gray-900">{{ total_double_time_hours }}</span>
                        <span class="ml-1 text-sm text-gray-500">hrs</span>
                    </div>
                </div>
            </div>

            <!-- Grand Total -->
            <div class="summary-card rounded-lg border border-gray-200 shadow-lg p-4 bg-gradient-to-br from-blue-50 to-white">
                <div class="flex flex-col">
                    <div class="text-sm font-medium text-gray-500 mb-1">Grand Total Hours</div>
                    <div class="flex items-baseline">
                        <span class="text-2xl font-semibold text-blue-600">{{ grand_total_hours }}</span>
                        <span class="ml-1 text-sm text-gray-500">hrs</span>
                    </div>
                </div>
            </div>
        </div>
<!-- Print Button -->
<div class="py-6 mb-4">
    <button onclick="window.print()" 
            class="inline-flex items-center px-4 py-2.5 bg-gradient-to-r from-gray-800 to-gray-900 
                   text-white rounded-xl font-medium
                   border border-transparent
                   hover:from-gray-700 hover:to-gray-800
                   focus:outline-none
                   transform transition-all duration-200
                   hover:scale-[1.02] active:scale-95
                   no-print">
        <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" 
                  d="M17 17h2a2 2 0 002-2v-4a2 2 0 00-2-2H5a2 2 0 00-2 2v4a2 2 0 002 2h2m2 4h6a2 2 0 002-2v-4a2 2 0 00-2-2H9a2 2 0 00-2 2v4a2 2 0 002 2zm8-12V5a2 2 0 00-2-2H9a2 2 0 00-2 2v4h10z"/>
        </svg>
        Print Report
    </button>
</div>

<script>
    document.addEventListener('DOMContentLoaded', () => {
        document.querySelectorAll('details').forEach((detail) => {
            detail.removeAttribute('open');
            
            const summary = detail.querySelector('summary');
            const arrow = summary.querySelector('svg');
            
            arrow.classList.add('rotate-180');
            
            detail.addEventListener('toggle', () => {
                if (detail.open) {
                    arrow.classList.remove('rotate-180');
                } else {
                    arrow.classList.add('rotate-180');
                }
            });
        });
    });
</script>
{% endblock %}
