{% extends 'timesheets/base.html' %}
{% load static %}

{% block title %}Time Entries Form - Time Sheet App{% endblock %}

{% block content %}
<style>
    /* Add any custom styling here */
</style>

<body>
    <div class="timesheet-form">
        <form method="post">
            {% csrf_token %}
            <div class="date-container">
                <label class="header" for="{{ form.date.id_for_label }}">Date:</label>
                {{ form.date }}
            </div>
            <div class="vehicle-container">
                <label class="header">{{ form.company_vehicle_used.label }}:</label>
                {% for radio in form.company_vehicle_used %}
                    <label class="radio-inline">
                        {{ radio.tag }}
                        {{ radio.choice_label }}
                    </label>
                {% endfor %}
            </div>
            <table>
                <thead>
                    <tr><th></th>
                        <th colspan="2">Client/Job</th>
                        <th colspan="2">Time</th>
                        <th colspan="2">Mileage</th>
                        <th colspan="3">Services Performed</th>
                        <td rowspan="3">
                            <a href="javascript:void(0);" id="add-job" class="add-job">Add Job</a>
                        </td>
                    </tr>
                    <tr>
                        <th></th>
                        <th colspan="2"></th>
                        <th>Arrive</th>
                        <th>Leave</th>
                        <th>Arrive</th>
                        <th>Leave</th>
                        <th colspan="3">Labor Code Description</th>
                    </tr>
                </thead>
                <tbody id="formset-container">
                    <!-- Render form fields for TimeEntry -->
                    <tr>
                        <td></td>
                        <td class="header">Start Location:</td>
                        <td>{{ form.start_location }}</td>
                        <td class="header"></td>
                        <td>{{ form.initial_leave_time }}</td>
                        <td class="header"></td>
                        <td>{{ form.initial_mileage }}</td>
                        <td class="header" colspan="3"></td>
                    </tr>

                    <!-- Include the formset management form -->
                    {{ job_formset.management_form }}

                    <!-- Render each form in the Job formset -->
                    {% for job_form in job_formset %}
                    <tr class="job-form">
                        {{ job_form.id }}
                        
                        <td>{{ job_form.DELETE }}</td>
                        
                        <td colspan="2">
                            {{ job_form.job_description }}
                        </td>
                        <td>{{ job_form.activity_arrive_time }}</td>
                        <td>{{ job_form.activity_leave_time }}</td>
                        <td>{{ job_form.activity_start_mileage }}</td>
                        <td>{{ job_form.activity_end_mileage }}</td>
                        <td colspan="3">
                            {{ job_form.labor_code_description }}
                        </td>
                        <td>
                            <a href="javascript:void(0);" class="remove-job">Remove</a>
                        </td>
                    </tr>
                    <!-- Hidden fields -->
                    <tr style="display: none;">
                        <td>
                            {{ job_form.job_number }}
                        </td>
                        <td>
                            {{ job_form.labor_code }}
                        </td>
                    </tr>
                    {% endfor %}

                    <!-- Render form fields for TimeEntry -->
                    <tr>
                        <td></td>
                        <td class="header">End Location:</td>
                        <td>{{ form.end_location }}</td>
                        <td class="header"></td>
                        <td>{{ form.final_arrive_time }}</td>
                        <td class="header"></td>
                        <td>{{ form.final_mileage }}</td>
                        <td class="header" colspan="3"></td>
                    </tr>
                    <tr>
                        <td></td>
                        <td class="header">Comments:</td>
                        <td colspan="8">{{ form.comments }}</td>
                    </tr>
                </tbody>
            </table>

            <div style="text-align: center;">
                <button type="submit">Save</button>
                <button type="button" class="cancel"><a href="{% url 'time_entry_list' %}">Cancel</a></button>
            </div>
        </form>
    </div>
</body>

<script type="text/javascript">
    document.addEventListener('DOMContentLoaded', function () {
        const formsetContainer = document.getElementById('formset-container');
        const addJobButton = document.getElementById('add-job');
        const totalFormsInput = document.getElementById('id_form-TOTAL_FORMS');
    
        function attachEventListeners(container) {
            const jobDescriptionFields = container.querySelectorAll('[name$="-job_description"]');
            const jobNumberFields = container.querySelectorAll('[name$="-job_number"]');
            const laborCodeFields = container.querySelectorAll('[name$="-labor_code"]');
            const laborCodeDescriptionFields = container.querySelectorAll('[name$="-labor_code_description"]');
    
            jobDescriptionFields.forEach((field, index) => {
                field.addEventListener('change', function () {
                    const selectedDescription = field.value;
                    if (selectedDescription) {
                        // Fetch and set job number
                        fetch(`/time-entry/get-job-number/${encodeURIComponent(selectedDescription)}/`)
                            .then(response => response.json())
                            .then(data => {
                                if (data.success) {
                                    jobNumberFields[index].value = data.job_number;
                                }
                            });
    
                        // Fetch job details for computed time and distance
                        fetch(`/time-entry/get-job-details/${encodeURIComponent(selectedDescription)}/`)
                            .then(response => response.json())
                            .then(data => {
                                if (data.success) {
                                    const timeField = document.getElementById('computed_time');
                                    const distanceField = document.getElementById('computed_distance');
                                    timeField.textContent = `Travel Time: ${data.travel_time} hours`;
                                    distanceField.textContent = `Distance: ${data.distance} miles`;
                                } else {
                                    alert('Job details not found.');
                                }
                            });
                    }
                });
            });
    
            laborCodeDescriptionFields.forEach((field, index) => {
                field.addEventListener('change', function () {
                    const selectedDescription = field.value;
                    if (selectedDescription) {
                        fetch(`/time-entry/get-labor-code/${encodeURIComponent(selectedDescription)}/`)
                            .then(response => response.json())
                            .then(data => {
                                if (data.success) {
                                    laborCodeFields[index].value = data.labor_code;
                                }
                            });
                    }
                });
            });
        }
    
        function initializeFields() {
            const jobDescriptionFields = formsetContainer.querySelectorAll('[name$="job_description"]');
            const jobNumberFields = formsetContainer.querySelectorAll('[name$="job_number"]');
    
            jobDescriptionFields.forEach((field, index) => {
                const selectedDescription = field.value;
                if (selectedDescription) {
                    // Fetch job number
                    fetch(`/time-entry/get-job-number/${encodeURIComponent(selectedDescription)}/`)
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                jobNumberFields[index].value = data.job_number;
                            }
                        });
                   }
            });
    
            const laborCodeDescriptionFields = formsetContainer.querySelectorAll('[name$="labor_code_description"]');
            const laborCodeFields = formsetContainer.querySelectorAll('[name$="labor_code"]');
    
            laborCodeDescriptionFields.forEach((field, index) => {
                const selectedDescription = field.value;
                if (selectedDescription) {
                    fetch(`/time-entry/get-labor-code/${encodeURIComponent(selectedDescription)}/`)
                        .then(response => response.json())
                        .then(data => {
                            if (data.success) {
                                laborCodeFields[index].value = data.labor_code;
                            }
                        });
                }
            });
        }
    
        function addNewForm() {
            const forms = formsetContainer.querySelectorAll('.job-form');
            const formCount = forms.length;
            const newForm = forms[0].cloneNode(true);
        
            // Update indices in form fields
            const formRegex = new RegExp(`form-(\\d+)-`, 'g');
            newForm.innerHTML = newForm.innerHTML.replace(formRegex, `form-${formCount}-`);
            newForm.querySelectorAll('input, select, textarea').forEach(input => {
                if (input.type === 'checkbox' || input.type === 'radio') {
                    input.checked = false;
                } else {
                    input.value = '';
                }
                input.name = input.name.replace(formRegex, `form-${formCount}-`);
                input.id = input.id.replace(formRegex, `form-${formCount}-`);
            });
            
                    // Ensure the id field is present and empty for new forms
            let idField = newForm.querySelector('input[name$="-id"]');
            if (!idField) {
                idField = document.createElement('input');
                idField.type = 'hidden';
                idField.name = `form-${formCount}-id`;
                idField.id = `id_form-${formCount}-id`;
                newForm.appendChild(idField);
            }
            idField.value = '';

            // Ensure the DELETE checkbox is included and unchecked
            let deleteCheckbox = newForm.querySelector('input[name$="-DELETE"]');
            if (!deleteCheckbox) {
                // Create the DELETE checkbox
                const deleteCell = newForm.querySelector('td'); // Assuming DELETE checkbox is in the first cell
                deleteCheckbox = document.createElement('input');
                deleteCheckbox.type = 'checkbox';
                deleteCheckbox.name = `form-${formCount}-DELETE`;
                deleteCheckbox.id = `id_form-${formCount}-DELETE`;
                deleteCell.appendChild(deleteCheckbox);
            }
            deleteCheckbox.checked = false;
        
            // Insert the new form
            const endLocationRow = formsetContainer.querySelector('tr:nth-last-child(2)');
            formsetContainer.insertBefore(newForm, endLocationRow);
            totalFormsInput.value = formCount + 1;
        
            attachEventListeners(newForm); // Attach event listeners to the new form only
        }
    
        function removeForm(e) {
            if (e.target.classList.contains('remove-job')) {
                const jobForms = formsetContainer.querySelectorAll('.job-form');
                if (jobForms.length > 1) {
                    const jobForm = e.target.closest('.job-form');
                    const deleteCheckbox = jobForm.querySelector('input[name$="-DELETE"]');
                    if (deleteCheckbox) {
                        deleteCheckbox.checked = true;
                        jobForm.style.display = 'none';
                    } else {
                        jobForm.remove();
                        updateFormIndices();
                    }
                } else {
                    alert('At least one job must remain.');
                }
            }
        }
    
        function updateFormIndices() {
            const forms = formsetContainer.querySelectorAll('.job-form');
            forms.forEach((form, index) => {
                form.querySelectorAll('input, select, textarea').forEach(input => {
                    const oldName = input.name;
                    const newName = oldName.replace(/-\d+-/, `-${index}-`);
                    input.name = newName;
                    input.id = input.id.replace(/-\d+-/, `-${index}-`);
                });
            });
            totalFormsInput.value = forms.length;
        }
    
        addJobButton.addEventListener('click', addNewForm);
        formsetContainer.addEventListener('click', removeForm);
    
        attachEventListeners(formsetContainer);
        initializeFields();
    });
    
    </script>
{% endblock %}
